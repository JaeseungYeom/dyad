CONFIG = ../urpc.cfg
include ${CONFIG}

ifeq ($(URPC_DEBUG),1)
  URPC_OPTIONS += -DURPC_FULL_DEBUG=1
  URPC_OPTIONS += -DURPC_LOGGING_ON=1
  $(info URPC_DEBUG is enabled)
endif

all: urpc.so
	+$(MAKE) -C test

LIBB64_DIR = /p/lustre2/yeom2/FLUX/libb64
_CFLAGS = $(CFLAGS) $(C_VER) $(URPC_OPTIONS) -I../common -I$(FLUX_CORE_INCLUDES) -I$(LIBB64_DIR)/include
_LDFLAGS += $(LDFLAGS) -L$(FLUX_CORE_LIBPATH) -Wl,-rpath=$(FLUX_CORE_LIBPATH),--no-undefined -shared $(FLUX_CORE_LIBS) -ldl -ljansson -L$(LIBB64_DIR)/src -lb64
# --disable-static

urpc.so: urpc.o ../common/utils.o read_all.o
	$(CC) $(_CFLAGS) $^ -o $@ $(_LDFLAGS)
	#$(CC) $(_CFLAGS) -L$(FLUX_CORE_LIBPATH) -Wl,-rpath=$(FLUX_CORE_LIBPATH),--no-undefined -shared $^ -o $@ $(FLUX_CORE_LIBS) -ldl

urpc.o: urpc.c urpc_ctx.h
	$(CC) $(_CFLAGS) $< -c -o $@

read_all.o: read_all.c
	$(CC) $(_CFLAGS) $^ -c -o $@

start: urpc.so
	flux module load ./urpc.so $(shell readlink -f ../wrapper/test)/prod


.PHONY: clean install

install: urpc.so
	install -d ${PREFIX}/lib
	install -m 640 urpc.so ${PREFIX}/lib

clean:
	@rm -f *.o *.so
	+$(MAKE) clean -C test
