CONFIG = ../urpc.cfg
include ${CONFIG}

ifeq ($(URPC_DEBUG),1)
  URPC_OPTIONS += -DURPC_FULL_DEBUG=1
  URPC_OPTIONS += -DURPC_LOGGING_ON=1
  $(info URPC_DEBUG is enabled)
endif

C_VER=-std=c11
#C_VER=-std=c99
VER=${C_VER} -D_POSIX_C_SOURCE=200112L
CXX_VER=-std=c++11

_CFLAGS = $(CFLAGS) $(C_VER) $(URPC_OPTIONS) -I./ -I../common -I$(FLUX_CORE_INCLUDES)
_CXXFLAGS = $(CXXFLAGS) $(CXX_VER) $(URPC_OPTIONS) -I./ -I../common -I$(FLUX_CORE_INCLUDES)
_LDFLAGS = $(LDFLAGS) -L$(FLUX_CORE_LIBPATH) -Wl,-rpath=$(FLUX_CORE_LIBPATH),--no-undefined -shared $(FLUX_CORE_LIBS) -ldl
#--disable-static

ifeq ($(BUILD_TEST),1)
all: liburpc_client.so
	+$(MAKE) -C test
else
all: liburpc_client.so
endif

liburpc_client.so: urpc_client.o ../common/utils.o
	$(CC) $(_CFLAGS) $^ -o $@ $(_LDFLAGS)

urpc_client.o: urpc_client.c urpc_ctx.h ../common/utils.h
	$(CC) $(_CFLAGS) -DURPC_CHECK=1 $< -c -o $@



.PHONY: clean install

install: liburpc_client.so
	install -d ${PREFIX}/lib
	install -d ${PREFIX}/bin
	install -m 640 liburpc_client.so ${PREFIX}/lib

ifeq ($(BUILD_TEST),1)
clean:
	@rm -f *.o *~ liburpc_client.so
	+$(MAKE) clean -C test
else
clean:
	@rm -f *.o *~ liburpc_client.so
endif
